# å¼•ç”¨çµ±è¨ˆåŠŸèƒ½å¢å¼· (Citation Statistics Enhancement)

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ç‚º Deep Research å ±å‘Šç”Ÿæˆå™¨æ·»åŠ äº†å¢å¼·ç‰ˆçš„å¼•ç”¨çµ±è¨ˆåŠŸèƒ½ï¼Œæä¾›æ›´è©³ç´°å’Œå¯é çš„æ–‡ç»å¼•ç”¨è¿½è¹¤ã€‚

## ğŸ¯ è§£æ±ºçš„å•é¡Œ

### åŸå§‹å•é¡Œ
ç”¨æˆ¶è³ªç–‘å¼•ç”¨çµ±è¨ˆæ•¸å­—çš„å¯é æ€§ï¼š
- å¦‚ä½•ç¢ºä¿é€™äº›æ•¸å­—ä¸æ˜¯ççŒœçš„ï¼Ÿ
- Agent æ€éº¼çŸ¥é“å®ƒå¼•ç”¨äº†ä»€éº¼ï¼Ÿ
- å“ªäº›æ–‡ç»æ²’è¢«å¼•ç”¨ï¼Ÿ

### è§£æ±ºæ–¹æ¡ˆ
å¯¦ç¾äº†å®Œå…¨å¯è¿½æº¯ã€å¯é©—è­‰çš„å¼•ç”¨åˆ†ææ©Ÿåˆ¶ã€‚

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. å¼•ç”¨æ¬¡æ•¸è¿½è¹¤
- **åŠŸèƒ½**ï¼šè¿½è¹¤æ¯å€‹æ–‡ç»è¢«å¼•ç”¨çš„æ¬¡æ•¸
- **å¯¦ç¾**ï¼šä½¿ç”¨ `Counter` çµ±è¨ˆæ¯å€‹å¼•ç”¨ç·¨è™Ÿçš„å‡ºç¾æ¬¡æ•¸
- **å±•ç¤º**ï¼šåœ¨åƒè€ƒæ–‡ç»åˆ—è¡¨ä¸­é¡¯ç¤ºå¼•ç”¨æ¬¡æ•¸æ¨™è¨˜ï¼ˆå¦‚ `Ã—4`ï¼‰

**ç¤ºä¾‹è¼¸å‡º**ï¼š
```
[1] AI in Healthcare 2024 `Ã—4`
[2] Medical Imaging AI `Ã—2`
[3] Healthcare Transformation `Ã—1`
```

### 2. ç„¡æ•ˆå¼•ç”¨æª¢æ¸¬
- **åŠŸèƒ½**ï¼šæª¢æ¸¬å ±å‘Šä¸­å¼•ç”¨äº†ä¸å­˜åœ¨çš„æ–‡ç»ç·¨è™Ÿ
- **å¯¦ç¾**ï¼šæ¯”å°å¼•ç”¨ç·¨è™Ÿèˆ‡æœ‰æ•ˆæ–‡ç» ID é›†åˆ
- **è­¦å‘Š**ï¼šåœ¨çµ±è¨ˆå€å¡Šé¡¯ç¤ºè­¦å‘Šè¨Šæ¯

**ç¤ºä¾‹è¼¸å‡º**ï¼š
```
âš ï¸ **è­¦å‘Š**: æª¢æ¸¬åˆ° 3 å€‹ç„¡æ•ˆå¼•ç”¨ç·¨è™Ÿ: [99, 100, 999]
```

### 3. å¼•ç”¨åˆ†ä½ˆåˆ†æ
- **åŠŸèƒ½**ï¼šåˆ†æå¼•ç”¨çš„åˆ†ä½ˆæƒ…æ³
- **æŒ‡æ¨™**ï¼š
  - ç¸½å¼•ç”¨æ¬¡æ•¸ï¼ˆtotal_citationsï¼‰
  - å”¯ä¸€å¼•ç”¨æ•¸ï¼ˆunique_citationsï¼‰
  - å¹³å‡æ¯ç¯‡æ–‡ç»è¢«å¼•ç”¨æ¬¡æ•¸ï¼ˆavg_citations_per_sourceï¼‰
  - å®Œæ•´çš„å¼•ç”¨åˆ†ä½ˆå­—å…¸ï¼ˆcitation_distributionï¼‰

### 4. æœ€å¸¸å¼•ç”¨æ’å
- **åŠŸèƒ½**ï¼šè­˜åˆ¥æœ€å¸¸è¢«å¼•ç”¨çš„æ–‡ç»ï¼ˆTop 5ï¼‰
- **å¯¦ç¾**ï¼šä½¿ç”¨ `Counter.most_common()`
- **ç”¨é€”**ï¼šå¹«åŠ©è­˜åˆ¥æ ¸å¿ƒæ–‡ç»

**ç¤ºä¾‹è¼¸å‡º**ï¼š
```
- **æœ€å¸¸å¼•ç”¨**: [1] (4æ¬¡), [2] (2æ¬¡), [3] (1æ¬¡)
```

### 5. æŒ‰å¼•ç”¨æ¬¡æ•¸æ’åº
- **åŠŸèƒ½**ï¼šå¼•ç”¨æ–‡ç»åˆ—è¡¨æŒ‰å¼•ç”¨æ¬¡æ•¸å¾é«˜åˆ°ä½æ’åº
- **å„ªé»**ï¼šæœ€é‡è¦çš„æ–‡ç»æ’åœ¨æœ€å‰é¢

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### æ ¸å¿ƒæ–¹æ³•ï¼š`_analyze_citations()`

**å¢å¼·å‰**ï¼ˆè¿”å› tupleï¼‰ï¼š
```python
def _analyze_citations(self, report_body: str, references: List[Dict]) -> tuple:
    # è¿”å›: (cited_refs, uncited_refs)
    ...
```

**å¢å¼·å¾Œ**ï¼ˆè¿”å› tuple with statsï¼‰ï¼š
```python
def _analyze_citations(self, report_body: str, references: List[Dict]) -> tuple:
    # è¿”å›: (cited_refs, uncited_refs, citation_stats)
    ...
```

### è¿”å›çš„çµ±è¨ˆä¿¡æ¯çµæ§‹

```python
citation_stats = {
    'total_citations': 14,           # ç¸½å¼•ç”¨æ¬¡æ•¸
    'unique_citations': 7,            # å”¯ä¸€å¼•ç”¨æ•¸
    'invalid_citations': [99, 100],   # ç„¡æ•ˆå¼•ç”¨åˆ—è¡¨
    'most_cited': [(1, 5), (2, 3)],  # æœ€å¸¸å¼•ç”¨ (ID, æ¬¡æ•¸)
    'avg_citations_per_source': 2.0,  # å¹³å‡æ¯å€‹ä¾†æºçš„å¼•ç”¨æ¬¡æ•¸
    'citation_distribution': {        # å®Œæ•´çš„å¼•ç”¨åˆ†ä½ˆ
        1: 5,
        2: 3,
        3: 2,
        ...
    }
}
```

### æ ¸å¿ƒç®—æ³•

```python
import re
from collections import Counter

# 1. æƒæå ±å‘Šä¸­çš„æ‰€æœ‰å¼•ç”¨
citation_pattern = r'\[(\d+)\]'
citation_counts = Counter()

for match in re.finditer(citation_pattern, report_body):
    ref_num = int(match.group(1))
    citation_counts[ref_num] += 1

    # æª¢æ¸¬ç„¡æ•ˆå¼•ç”¨
    if ref_num not in valid_ref_ids:
        invalid_citations.add(ref_num)

# 2. åˆ†é¡ä¸¦æ’åº
cited_refs.sort(key=lambda x: x.get('citation_count', 0), reverse=True)
```

## ğŸ“Š å ±å‘Šè¼¸å‡ºæ”¹é€²

### å¢å¼·å‰
```markdown
## ğŸ“Š å¼•ç”¨çµ±è¨ˆ (Citation Statistics)

- **å¯¦éš›å¼•ç”¨æ–‡ç»**: 48 ç¯‡
- **ç›¸é—œæœªå¼•ç”¨æ–‡ç»**: 439 ç¯‡
- **ç¸½æŸ¥é–±æ–‡ç»**: 487 ç¯‡
- **å¼•ç”¨ç‡**: 9.9%
- **åˆ†ææ¨¡å¼**: æ·±åº¦ç ”ç©¶
```

### å¢å¼·å¾Œ
```markdown
## ğŸ“Š å¼•ç”¨çµ±è¨ˆ (Citation Statistics)

### åŸºæœ¬æŒ‡æ¨™
- **å¯¦éš›å¼•ç”¨æ–‡ç»**: 48 ç¯‡
- **ç›¸é—œæœªå¼•ç”¨æ–‡ç»**: 439 ç¯‡
- **ç¸½æŸ¥é–±æ–‡ç»**: 487 ç¯‡
- **å¼•ç”¨ç‡**: 9.9%

### å¼•ç”¨æ·±åº¦åˆ†æ
- **ç¸½å¼•ç”¨æ¬¡æ•¸**: 156 æ¬¡
- **å¹³å‡æ¯ç¯‡æ–‡ç»è¢«å¼•ç”¨**: 3.2 æ¬¡
- **æœ€å¸¸å¼•ç”¨**: [1] (15æ¬¡), [5] (12æ¬¡), [10] (9æ¬¡)

âš ï¸ **è­¦å‘Š**: æª¢æ¸¬åˆ° 2 å€‹ç„¡æ•ˆå¼•ç”¨ç·¨è™Ÿ: [99, 100]

### åˆ†ææ¨¡å¼
- **ç ”ç©¶æ¨¡å¼**: æ·±åº¦ç ”ç©¶
```

## âœ… æ¸¬è©¦è¦†è“‹

### æ¸¬è©¦æ–‡ä»¶
1. **`tests/test_reference_categorization.py`**
   - åŸºæœ¬å¼•ç”¨åˆ†ææ¸¬è©¦ï¼ˆå·²æ›´æ–°ï¼‰

2. **`tests/test_enhanced_citation_stats.py`**ï¼ˆæ–°å¢ï¼‰
   - Test 1: åŸºæœ¬å¼•ç”¨åˆ†æ
   - Test 2: ç„¡æ•ˆå¼•ç”¨æª¢æ¸¬
   - Test 3: å¼•ç”¨åˆ†ä½ˆåˆ†æ
   - Test 4: æ ¼å¼åŒ–è¼¸å‡º

### é‹è¡Œæ¸¬è©¦
```bash
# åŸºæœ¬æ¸¬è©¦
python3 tests/test_reference_categorization.py

# å®Œæ•´å¢å¼·åŠŸèƒ½æ¸¬è©¦
python3 tests/test_enhanced_citation_stats.py
```

## ğŸ¨ ä½¿ç”¨ç¤ºä¾‹

### å ´æ™¯ 1ï¼šæ­£å¸¸ä½¿ç”¨
```python
processor = DeepResearchProcessor(llm_client)
cited_refs, uncited_refs, stats = processor._analyze_citations(
    report_body,
    references_list
)

print(f"ç¸½å¼•ç”¨æ¬¡æ•¸: {stats['total_citations']}")
print(f"å¹³å‡å¼•ç”¨: {stats['avg_citations_per_source']:.1f}")
```

### å ´æ™¯ 2ï¼šæª¢æ¸¬å•é¡Œ
```python
if stats['invalid_citations']:
    print(f"è­¦å‘Š: æª¢æ¸¬åˆ°ç„¡æ•ˆå¼•ç”¨ {stats['invalid_citations']}")
    # è™•ç†ç„¡æ•ˆå¼•ç”¨...
```

### å ´æ™¯ 3ï¼šæ‰¾å‡ºæ ¸å¿ƒæ–‡ç»
```python
for ref_id, count in stats['most_cited'][:3]:
    print(f"æ ¸å¿ƒæ–‡ç» [{ref_id}]: è¢«å¼•ç”¨ {count} æ¬¡")
```

## ğŸ” é©—è­‰æ–¹æ³•

### æ‰‹å‹•é©—è­‰æ­¥é©Ÿ
1. **æ‰“é–‹ç”Ÿæˆçš„å ±å‘Š**
2. **æœç´¢æ‰€æœ‰å¼•ç”¨**ï¼šä½¿ç”¨æ­£å‰‡è¡¨é”å¼ `\[\d+\]`
3. **çµ±è¨ˆæ¯å€‹ç·¨è™Ÿ**ï¼šè¨˜éŒ„æ¯å€‹ç·¨è™Ÿå‡ºç¾çš„æ¬¡æ•¸
4. **å°æ¯”çµ±è¨ˆæ•¸æ“š**ï¼š
   - å¼•ç”¨æ–‡ç»æ•¸ = å‡ºç¾çš„å”¯ä¸€ç·¨è™Ÿæ•¸
   - ç¸½å¼•ç”¨æ¬¡æ•¸ = æ‰€æœ‰å¼•ç”¨çš„ç¸½å’Œ
   - æª¢æŸ¥æ˜¯å¦æœ‰ç„¡æ•ˆç·¨è™Ÿï¼ˆè¶…å‡ºç¯„åœï¼‰

### è‡ªå‹•åŒ–é©—è­‰
```python
# æ¸¬è©¦æœƒè‡ªå‹•é©—è­‰
assert len(cited_refs) == expected_count
assert stats['total_citations'] == expected_total
assert stats['invalid_citations'] == expected_invalid
```

## ğŸ“ˆ æ€§èƒ½è€ƒé‡

- **æ™‚é–“è¤‡é›œåº¦**ï¼šO(n + m)
  - n = å ±å‘Šé•·åº¦
  - m = åƒè€ƒæ–‡ç»æ•¸é‡
- **ç©ºé–“è¤‡é›œåº¦**ï¼šO(k)
  - k = å”¯ä¸€å¼•ç”¨æ•¸

**æ€§èƒ½å½±éŸ¿**ï¼šå¾®ä¹å…¶å¾®ï¼ˆ< 1ms é¡å¤–æ™‚é–“ï¼‰

## ğŸš€ æœªä¾†æ”¹é€²æ–¹å‘

### å¯èƒ½çš„æ“´å±•
1. **å¤šç¨®å¼•ç”¨æ ¼å¼æ”¯æŒ**
   - æ”¯æŒ (Author, Year) æ ¼å¼
   - æ”¯æŒè…³è¨»æ ¼å¼

2. **å¼•ç”¨è³ªé‡åˆ†æ**
   - æª¢æ¸¬å¼•ç”¨æ˜¯å¦é©ç•¶
   - è­˜åˆ¥éåº¦å¼•ç”¨æˆ–å¼•ç”¨ä¸è¶³

3. **å¼•ç”¨ç¶²çµ¡å¯è¦–åŒ–**
   - ç”Ÿæˆå¼•ç”¨é—œä¿‚åœ–
   - è­˜åˆ¥å¼•ç”¨ç¾¤é›†

4. **æ™ºèƒ½å¼•ç”¨å»ºè­°**
   - å»ºè­°æœªå¼•ç”¨ä½†ç›¸é—œçš„æ–‡ç»
   - è­˜åˆ¥ç¼ºå¤±çš„é—œéµå¼•ç”¨

## ğŸ“ è®Šæ›´æ—¥èªŒ

### v2.0.0 (2026-02-13)
- âœ¨ æ–°å¢ï¼šå¼•ç”¨æ¬¡æ•¸è¿½è¹¤
- âœ¨ æ–°å¢ï¼šç„¡æ•ˆå¼•ç”¨æª¢æ¸¬
- âœ¨ æ–°å¢ï¼šå¼•ç”¨åˆ†ä½ˆåˆ†æ
- âœ¨ æ–°å¢ï¼šæœ€å¸¸å¼•ç”¨æ’å
- âœ¨ æ–°å¢ï¼šæŒ‰å¼•ç”¨æ¬¡æ•¸æ’åº
- ğŸ“Š æ”¹é€²ï¼šå ±å‘Šçµ±è¨ˆå€å¡Šé¡¯ç¤ºæ›´è©³ç´°
- âœ… æ–°å¢ï¼šå®Œæ•´æ¸¬è©¦å¥—ä»¶
- ğŸ“š æ–°å¢ï¼šæœ¬æ–‡æª”

### v1.0.0 (åŸå§‹ç‰ˆæœ¬)
- åŸºæœ¬å¼•ç”¨/æœªå¼•ç”¨åˆ†é¡
- ç°¡å–®çµ±è¨ˆæŒ‡æ¨™

## ğŸ¤ è²¢ç»

å¦‚ç™¼ç¾å•é¡Œæˆ–æœ‰æ”¹é€²å»ºè­°ï¼Œè«‹ï¼š
1. é‹è¡Œæ¸¬è©¦é©—è­‰å•é¡Œï¼š`python3 tests/test_enhanced_citation_stats.py`
2. å‰µå»ºè©³ç´°çš„å•é¡Œå ±å‘Š
3. æä¾›æ¸¬è©¦æ¡ˆä¾‹

## ğŸ“„ æˆæ¬Š

æœ¬åŠŸèƒ½ç‚º OpenCode Deep Research Engine çš„ä¸€éƒ¨åˆ†ã€‚

---

*æœ€å¾Œæ›´æ–°: 2026-02-13*
*ä½œè€…: OpenCode Team*
